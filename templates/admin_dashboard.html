{% extends "base.html" %} {% block title %}Administración{% endblock %} {% block
body %}
<div class="dashboard-container">
  <nav class="dashboard-nav">
    <div class="nav-brand">
      <h2>InternLink</h2>
      <span class="badge badge-admin">Administrador</span>
    </div>
    <div class="nav-user">
      <span>{{ user.name | default(user.email, true) }}</span>
      <a href="{{ url_for('logout') }}" class="btn btn-secondary btn-sm"
        >Cerrar Sesión</a
      >
    </div>
  </nav>

  <div class="dashboard-content">
    <div class="dashboard-header">
      <h1>Panel de Administración</h1>
      <p>
        Gestión de pasantías, ofertas y convenios. Use las herramientas de
        soporte para diagnóstico o auditoría.
      </p>
    </div>

    <div class="dashboard-grid">
      <!-- Gestión de salarios -->
      <div class="card">
        <div class="card-header">
          <h3>Gestión de Salarios</h3>
        </div>
        <div class="card-body">
          <div class="form-group">
            <label for="salaryStudentId">Estudiante</label>
            <select id="salaryStudentId" class="form-input">
              <option value="">— Seleccionar estudiante —</option>
              {% for s in students %}
              <option value="{{ s.id }}">{{ s.name }} ({{ s.email }})</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label for="salaryAmount">Nuevo salario (COP)</label>
            <input
              type="number"
              id="salaryAmount"
              value="1500000"
              class="form-input"
            />
          </div>
          <button onclick="updateSalary()" class="btn btn-primary">
            Actualizar Salario
          </button>
          <div id="salaryStatus" class="mt-2"></div>
        </div>
      </div>

      <!-- Gestión de ofertas -->
      <div class="card">
        <div class="card-header">
          <h3>Gestión de Ofertas</h3>
        </div>
        <div class="card-body">
          <div class="form-group">
            <label for="offerId">Oferta</label>
            <select id="offerId" class="form-input">
              <option value="">— Seleccionar oferta —</option>
              {% for o in offers %}
              <option value="{{ o.id }}">
                {{ o.title }} — {{ o.company_name }}
              </option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label for="offerStatusSelect">Estado</label>
            <select id="offerStatusSelect" class="form-input">
              <option value="active">Activa</option>
              <option value="pending">Pendiente</option>
              <option value="rejected">Rechazada</option>
              <option value="closed">Cerrada</option>
            </select>
          </div>
          <button onclick="approveOffer()" class="btn btn-primary">
            Cambiar Estado
          </button>
          <div id="offerStatusResult" class="mt-2"></div>
        </div>
      </div>

      <!-- Estudiantes con cuenta en la plataforma -->
      <div class="card card-wide">
        <div class="card-header">
          <h3>Estudiantes con cuenta</h3>
        </div>
        <div class="card-body">
          {% if students %}
          <table class="data-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Email</th>
                <th>Universidad</th>
                <th>Cuenta Bancolombia (pago)</th>
                <th>Rol</th>
              </tr>
            </thead>
            <tbody>
              {% for s in students %}
              <tr>
                <td>{{ s.id }}</td>
                <td>{{ s.name }}</td>
                <td>{{ s.email }}</td>
                <td>{{ s.university | default('—', true) }}</td>
                <td><code>{{ s.bank_account | default('—', true) }}</code></td>
                <td><span class="badge badge-student">{{ s.role }}</span></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% else %}
          <p class="text-muted">
            No hay estudiantes con cuenta en la plataforma.
          </p>
          {% endif %}
        </div>
      </div>

      <!-- Convenios de pasantía en curso -->
      <div class="card card-wide">
        <div class="card-header">
          <h3>Convenios de pasantía</h3>
        </div>
        <div class="card-body">
          {% if interns %}
          <table class="data-table">
            <thead>
              <tr>
                <th>Estudiante</th>
                <th>Empresa</th>
                <th>Cargo</th>
                <th>Salario</th>
                <th>Estado</th>
              </tr>
            </thead>
            <tbody>
              {% for i in interns %}
              <tr>
                <td>{{ i.student_name }}</td>
                <td>{{ i.company_name }}</td>
                <td>{{ i.position }}</td>
                <td>${{ i.salary }} COP</td>
                <td><span class="badge badge-student">{{ i.status }}</span></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% else %}
          <p class="text-muted">No hay convenios de pasantía activos.</p>
          {% endif %}
        </div>
      </div>

      <!-- Ofertas de pasantía -->
      <div class="card">
        <div class="card-header">
          <h3>Ofertas de Pasantía</h3>
        </div>
        <div class="card-body">
          {% if offers %}
          <ul class="list">
            {% for o in offers %}
            <li>
              <strong>{{ o.title }}</strong> — {{ o.company_name }}<br />
              <small
                >Estado: <span class="badge badge-info">{{ o.status }}</span> |
                ID: {{ o.id }}</small
              >
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <p class="text-muted">No hay ofertas registradas.</p>
          {% endif %}
        </div>
      </div>

      <!-- Configuración del sistema -->
      <div class="card card-config">
        <div class="card-header">
          <h3>Configuración del sistema</h3>
        </div>
        <div class="card-body card-body-config">
          {% if config_main %}
          <table class="data-table config-table">
            <thead>
              <tr>
                <th>Parámetro</th>
                <th>Valor</th>
              </tr>
            </thead>
            <tbody>
              {% for key, value in config_main.items() %}
              <tr>
                <td><code>{{ key }}</code></td>
                <td><code>{{ value }}</code></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% else %}
          <p class="text-muted">No se pudo cargar la configuración.</p>
          {% endif %}
        </div>
      </div>

      <!-- Herramientas de soporte (diagnóstico / auditoría) -->
      <div class="card">
        <div class="card-header">
          <h3>Herramientas de soporte</h3>
        </div>
        <div class="card-body">
          <p class="text-muted" style="font-size: 0.9rem">
            Registro del sistema para incidencias y auditoría.
          </p>
          {% if config_soporte.get('debug_log_path') %}
          <p style="margin: 0.5rem 0">
            <code>{{ config_soporte.get('debug_log_path') }}</code>
          </p>
          <a
            href="{{ config_soporte.get('debug_log_path') }}"
            target="_blank"
            rel="noopener"
            class="btn btn-secondary btn-sm"
            >Abrir registro del sistema</a
          >
          {% else %}
          <p class="text-muted">Ruta de logs no configurada.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  var adminToken = {{ admin_token | tojson }};
  function adminHeaders() {
      var h = { 'Content-Type': 'application/json' };
      if (adminToken) h['Authorization'] = 'Bearer ' + adminToken;
      return h;
  }
  async function updateSalary() {
      const status = document.getElementById('salaryStatus');
      const studentId = document.getElementById('salaryStudentId').value;
      if (!studentId) {
          status.innerHTML = '<div class="alert alert-error">Selecciona un estudiante.</div>';
          return;
      }
      try {
          const res = await fetch('/api/admin/update-salary', {
              method: 'POST',
              headers: adminHeaders(),
              body: JSON.stringify({
                  student_id: studentId,
                  salary: document.getElementById('salaryAmount').value
              }),
              credentials: 'include'
          });
          const data = await res.json();
          status.innerHTML = data.success
              ? '<div class="alert alert-success">' + data.message + '</div>'
              : '<div class="alert alert-error">' + (data.error || 'Error') + '</div>';
      } catch (err) {
          status.innerHTML = '<div class="alert alert-error">Error de conexión</div>';
      }
  }

  async function approveOffer() {
      const status = document.getElementById('offerStatusResult');
      const offerId = document.getElementById('offerId').value;
      if (!offerId) {
          status.innerHTML = '<div class="alert alert-error">Selecciona una oferta.</div>';
          return;
      }
      try {
          const res = await fetch('/api/admin/approve-offer', {
              method: 'POST',
              headers: adminHeaders(),
              body: JSON.stringify({
                  offer_id: offerId,
                  status: document.getElementById('offerStatusSelect').value
              }),
              credentials: 'include'
          });
          const data = await res.json();
          status.innerHTML = data.success
              ? '<div class="alert alert-success">' + data.message + '</div>'
              : '<div class="alert alert-error">' + (data.error || 'Error') + '</div>';
      } catch (err) {
          status.innerHTML = '<div class="alert alert-error">Error de conexión</div>';
      }
  }
</script>
{% endblock %}
