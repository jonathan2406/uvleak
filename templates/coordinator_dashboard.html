{% extends "base.html" %}

{% block title %}Panel Coordinador{% endblock %}

{% block body %}
<div class="dashboard-container">
    <nav class="dashboard-nav">
        <div class="nav-brand">
            <h2>InternLink</h2>
            <span class="badge badge-coordinator">Coordinador</span>
        </div>
        <div class="nav-user">
            <span>{{ user.name }}</span>
            <a href="{{ url_for('logout') }}" class="btn btn-secondary">Cerrar Sesi√≥n</a>
        </div>
    </nav>

    <div class="dashboard-content">
        <div class="dashboard-header">
            <h1>Panel de Coordinador</h1>
            <p>Gesti√≥n de pasant√≠as y candidatos</p>
        </div>

        <div class="dashboard-grid">
            <!-- Card: Exportar Datos -->
            <div class="card">
                <div class="card-header">
                    <h3>üìä Exportar Candidatos</h3>
                </div>
                <div class="card-body">
                    <p>Descarga el archivo con informaci√≥n de todos los candidatos.</p>
                    <a href="/exports/candidates" class="btn btn-primary" target="_blank">
                        Descargar Archivo
                    </a>
                    <div class="alert alert-info mt-3">
                        <strong>üí° Pista:</strong> Si el archivo se ve extra√±o, gu√°rdalo y anal√≠zalo con herramientas como <code>file</code> o √°brelo en Excel.
                    </div>
                </div>
            </div>

            <!-- Card: Estad√≠sticas -->
            <div class="card">
                <div class="card-header">
                    <h3>üìà Estad√≠sticas</h3>
                </div>
                <div class="card-body">
                    <ul class="list">
                        <li>Estudiantes activos: 15</li>
                        <li>Empresas registradas: 8</li>
                        <li>Ofertas publicadas: 23</li>
                        <li>Contratos activos: 7</li>
                    </ul>
                </div>
            </div>

            <!-- Card: Accesos especiales -->
            <div class="card">
                <div class="card-header">
                    <h3>üîê Acceso Avanzado</h3>
                </div>
                <div class="card-body">
                    <p>Como coordinador tienes acceso a endpoints administrativos.</p>
                    <div class="form-group">
                        <label>Probar autenticaci√≥n JWT:</label>
                        <textarea id="jwtToken" class="form-input" rows="3" placeholder="Pega tu token JWT aqu√≠"></textarea>
                    </div>
                    <button onclick="verifyJWT()" class="btn btn-warning">Verificar Token</button>
                    <div id="jwtResult" class="mt-2"></div>
                    
                    <div class="alert alert-info mt-3">
                        <strong>üí° Pista:</strong> Revisa el archivo Excel descargado para encontrar informaci√≥n √∫til.
                    </div>
                </div>
            </div>

            <!-- Card: Flags -->
            <div class="card card-flag">
                <div class="card-header">
                    <h3>üö© Flags CTF Capturados</h3>
                </div>
                <div class="card-body">
                    <div id="flagsList"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ACTO 7: Verificar JWT
async function verifyJWT() {
    const token = document.getElementById('jwtToken').value;
    const resultEl = document.getElementById('jwtResult');
    
    if (!token) {
        resultEl.innerHTML = '<div class="alert alert-error">Ingresa un token</div>';
        return;
    }
    
    try {
        const response = await fetch('/api/auth/verify-jwt', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ token: token })
        });
        
        const data = await response.json();
        
        if (data.valid) {
            let html = '<div class="alert alert-success">‚úÖ Token v√°lido</div>';
            html += '<pre>' + JSON.stringify(data.user, null, 2) + '</pre>';
            
            if (data.flag) {
                html += `<div class="alert alert-success mt-2">üö© ${data.flag}</div>`;
                addFlag(data.flag);
            }
            
            resultEl.innerHTML = html;
        } else {
            resultEl.innerHTML = '<div class="alert alert-error">‚ùå Token inv√°lido</div>';
        }
    } catch (error) {
        resultEl.innerHTML = '<div class="alert alert-error">Error al verificar token</div>';
    }
}

// Sistema de flags
function addFlag(flag) {
    const flags = JSON.parse(localStorage.getItem('ctf_flags') || '[]');
    if (!flags.includes(flag)) {
        flags.push(flag);
        localStorage.setItem('ctf_flags', JSON.stringify(flags));
    }
    displayFlags();
}

function displayFlags() {
    const flagsList = document.getElementById('flagsList');
    const flags = JSON.parse(localStorage.getItem('ctf_flags') || '[]');
    
    if (flags.length === 0) {
        flagsList.innerHTML = '<p class="text-muted">No hay flags capturados...</p>';
    } else {
        flagsList.innerHTML = '<ul class="flag-list">' + 
            flags.map(f => `<li>üö© <code>${f}</code></li>`).join('') + 
            '</ul>';
    }
}

displayFlags();
</script>
{% endblock %}
