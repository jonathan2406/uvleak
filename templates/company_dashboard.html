{% extends "base.html" %}

{% block title %}Panel Empresa{% endblock %}

{% block body %}
<div class="dashboard-container">
    <nav class="dashboard-nav">
        <div class="nav-brand">
            <h2>InternLink</h2>
            <span class="badge badge-company">Empresa</span>
        </div>
        <div class="nav-user">
            <span>{{ user.name }}</span>
            <a href="{{ url_for('logout') }}" class="btn btn-secondary">Cerrar Sesi칩n</a>
        </div>
    </nav>

    <div class="dashboard-content">
        <div class="dashboard-header">
            <h1>Panel de Empresa</h1>
            <p>{{ user.name }}</p>
        </div>

        <div class="alert alert-success">
            <strong>游뛀 ACTO 3 Completado:</strong> {{ flag }}
        </div>

        <div class="dashboard-grid">
            <!-- Card: Candidatos -->
            <div class="card">
                <div class="card-header">
                    <h3>游논 Ver Candidatos</h3>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label>ID de Empresa a consultar:</label>
                        <input type="number" id="companyIdInput" value="{{ user.id }}" class="form-input">
                        <small class="form-hint">Prueba con diferentes IDs (1, 2, 3...)</small>
                    </div>
                    <button onclick="loadCandidates()" class="btn btn-primary">
                        Cargar Candidatos
                    </button>
                    <div id="candidatesList" class="mt-3"></div>
                </div>
            </div>

            <!-- Card: Publicar Oferta -->
            <div class="card">
                <div class="card-header">
                    <h3>游닉 Publicar Oferta</h3>
                </div>
                <div class="card-body">
                    <form>
                        <div class="form-group">
                            <label>T칤tulo del puesto:</label>
                            <input type="text" class="form-input" placeholder="Ej: Desarrollador Backend">
                        </div>
                        <div class="form-group">
                            <label>Descripci칩n:</label>
                            <textarea class="form-input" rows="3"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Publicar</button>
                    </form>
                </div>
            </div>

            <!-- Card: Flags -->
            <div class="card card-flag">
                <div class="card-header">
                    <h3>游뛀 Flags CTF Capturados</h3>
                </div>
                <div class="card-body">
                    <div id="flagsList"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ACTO 4: IDOR Horizontal
async function loadCandidates() {
    const companyId = document.getElementById('companyIdInput').value;
    const listEl = document.getElementById('candidatesList');
    
    listEl.innerHTML = '<p class="text-info">Cargando...</p>';
    
    try {
        const response = await fetch(`/api/company/candidates?company_id=${companyId}`);
        const data = await response.json();
        
        if (data.candidates) {
            let html = '<div class="alert alert-info">Candidatos de la empresa ' + data.company_id + '</div>';
            html += '<ul class="list">';
            
            data.candidates.forEach(c => {
                html += `<li><strong>${c.name}</strong> - ${c.email}<br>
                        <small>CV: ${c.cv_path}</small></li>`;
            });
            
            html += '</ul>';
            
            if (data.flag) {
                html += `<div class="alert alert-success mt-2">游뛀 ${data.flag}</div>`;
                addFlag(data.flag);
            }
            
            listEl.innerHTML = html;
        }
    } catch (error) {
        listEl.innerHTML = '<div class="alert alert-error">Error al cargar</div>';
    }
}

// Sistema de flags
function addFlag(flag) {
    const flags = JSON.parse(localStorage.getItem('ctf_flags') || '[]');
    if (!flags.includes(flag)) {
        flags.push(flag);
        localStorage.setItem('ctf_flags', JSON.stringify(flags));
    }
    displayFlags();
}

function displayFlags() {
    const flagsList = document.getElementById('flagsList');
    const flags = JSON.parse(localStorage.getItem('ctf_flags') || '[]');
    
    if (flags.length === 0) {
        flagsList.innerHTML = '<p class="text-muted">No hay flags capturados...</p>';
    } else {
        flagsList.innerHTML = '<ul class="flag-list">' + 
            flags.map(f => `<li>游뛀 <code>${f}</code></li>`).join('') + 
            '</ul>';
    }
}

displayFlags();
</script>
{% endblock %}
