{% extends "base.html" %} {% block title %}Acceso a InternLink{% endblock %} {%
block body %}
<div class="auth-container">

  <div class="auth-card">
    <div class="logo-section">
      <img src="{{ url_for('static', filename='uploads/udemlogo.png') }}" alt="UDEM Logo" class="udem-logo-main">
      <h1 class="platform-name">InternLink</h1>
      <p class="platform-subtitle">Sistema de Gestión de Pasantías</p>
    </div>

    <div class="auth-form-section">
      <div class="auth-layout">
        <div class="auth-main-column">
          <h2 class="form-title">Verificación de invitación</h2>

          {% if request.args.get('msg') == 'verify_first' %}
          <div id="gateVerifyFirstWarning" class="alert alert-warning">
            Debe verificar su invitación antes de acceder al inicio de sesión o al
            registro.
          </div>
          {% endif %}

          <div id="gateFormBlock">
            <form id="gateForm" class="auth-form">
              <div class="form-group">
                <label for="gateEmail">Correo del invitador</label>
                <input
                  type="email"
                  id="gateEmail"
                  name="email"
                  required
                  placeholder="invitador@ejemplo.com"
                  class="form-input"
                  autocomplete="email"
                />
              </div>
              <button type="submit" class="btn btn-primary btn-block">
                Verificar invitación
              </button>
            </form>
            <p class="gate-hint text-muted mt-2" style="font-size: 0.8rem">
              Soporte: el recurso de verificación de correo admite más de un tipo de
              solicitud.
            </p>
            <div id="gateStatus" class="mt-2"></div>
          </div>

          <div id="gateResultBlock" class="gate-result" style="display: none">
            <div id="gateResultMessage" class="alert"></div>
            <div class="gate-actions" id="gateActions" style="display: none">
              <a id="gateLoginLink" href="#" class="btn btn-primary"
                >Iniciar sesión</a
              >
              <a id="gateRegisterLink" href="#" class="btn btn-primary"
                >Crear cuenta nueva</a
              >
            </div>
            <p id="gateHint" class="gate-hint" style="display: none"></p>
            <button type="button" id="gateBackBtn" class="btn btn-secondary mt-2">
              Verificar otro correo
            </button>
          </div>
        </div>

        <aside class="auth-instructions">
          <h3>Para ingresar al sistema siga los siguientes pasos.</h3>
          <ol>
            <li>Ingrese el correo de la persona que lo invitó.</li>
            <li>Valide la invitación antes de continuar.</li>
            <li>Use el enlace de acceso disponible al finalizar.</li>
          </ol>
          <p class="gate-description">
            Para acceder a InternLink debe ingresar el correo electrónico de la
            persona que lo invitó a la plataforma.
          </p>
          <p class="text-muted" style="font-size: 0.85rem; margin-top: 0.5rem;">
            <strong>Laboratorio de seguridad.</strong> Objetivo del ejercicio: demostrar el compromiso total de la plataforma y recuperar la evidencia crítica que el cliente ha identificado (consulte el enunciado del lab).
          </p>
        </aside>
      </div>

      <div class="footer-info">
        <p><strong>Competencias Digitales | Universidad de Medellín</strong></p>
        <p class="footer-address">Carrera 87 N° 30 - 65 Bloque 11 Oficina 214</p>
        <p class="footer-address" style="margin-top: 0.5rem; font-size: 0.75rem;">InternLink &copy; 2026</p>
      </div>
    </div>
  </div>

  <!-- Iconos de ayuda flotantes -->
  <div class="help-icons">
    <div class="help-icon accessibility" title="Accesibilidad">♿</div>
    <div class="help-icon support" title="Ayuda">?</div>
  </div>
</div>

<script>
  (function () {
    const form = document.getElementById("gateForm");
    const formBlock = document.getElementById("gateFormBlock");
    const resultBlock = document.getElementById("gateResultBlock");
    const resultMessage = document.getElementById("gateResultMessage");
    const statusEl = document.getElementById("gateStatus");
    const loginLink = document.getElementById("gateLoginLink");
    const registerLink = document.getElementById("gateRegisterLink");
    const backBtn = document.getElementById("gateBackBtn");

    form.addEventListener("submit", async function (e) {
      e.preventDefault();
      const email = document.getElementById("gateEmail").value.trim();
      if (!email) return;

      statusEl.innerHTML = '<p class="text-info">Comprobando invitación...</p>';
      statusEl.style.display = "block";

      try {
        const res = await fetch("/api/check-email", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email: email }),
        });
        const data = await res.json();

        statusEl.style.display = "none";
        formBlock.style.display = "none";
        resultBlock.style.display = "block";

        const baseLogin = "{{ url_for('login') }}";
        const baseRegister = "{{ url_for('register') }}";
        const sep = baseLogin.indexOf("?") >= 0 ? "&" : "?";

        const actionsEl = document.getElementById("gateActions");
        const hintEl = document.getElementById("gateHint");

        if (data.valid_inviter) {
          resultMessage.className = "alert alert-success";
          resultMessage.textContent = data.message;
          loginLink.href =
            baseLogin + sep + "email=" + encodeURIComponent(email);
          loginLink.style.display = "inline-block";
          registerLink.href = baseRegister;
          registerLink.style.display = "inline-block";
          actionsEl.style.display = "flex";
          hintEl.style.display = "none";
          var verifyWarning = document.getElementById("gateVerifyFirstWarning");
          if (verifyWarning) verifyWarning.style.display = "none";
        } else {
          resultMessage.className = "alert alert-warning";
          resultMessage.textContent = data.message;
          hintEl.textContent =
            "Solo algunos usuarios tienen permiso para invitar. Si no tiene el correo, consulte con sistemas o revise el recurso de verificación.";
          hintEl.style.display = "block";
          hintEl.className = "gate-hint text-muted";
          actionsEl.style.display = "none";
        }
      } catch (err) {
        statusEl.innerHTML =
          '<div class="alert alert-error">Error de conexión. Intente de nuevo.</div>';
        statusEl.style.display = "block";
      }
    });

    backBtn.addEventListener("click", function () {
      resultBlock.style.display = "none";
      formBlock.style.display = "block";
      document.getElementById("gateEmail").value = "";
      document.getElementById("gateEmail").focus();
    });
  })();
</script>
{% endblock %}
